{% extends "layout.html" %}

{% block title %}Servicio de Secado a Cliente{% endblock %}

{% block content %}
  <h1>Registrar Servicio de Secado a Cliente</h1>
  <p>Utiliza este formulario para registrar un servicio de secado pagado por un cliente. Esta operación generará un ingreso y no afectará tu inventario.</p>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="post" id="servicio-secado-form">
    <fieldset>
      <legend>Datos del Cliente y Producto</legend>

      <label for="cliente">Nombre del Cliente:</label>
      <input type="text" name="cliente" id="cliente" required><br><br>

      <label for="lote_cliente">Lote del Cliente (Opcional):</label>
      <input type="text" name="lote_cliente" id="lote_cliente"><br><br>

      <label for="producto_id">Producto Procesado:</label>
      <select name="producto_id" id="producto_id" required>
        <option value="" disabled selected>Seleccione un producto</option>
        {% for id, nombre, req in productos %}
          <option value="{{ id }}" data-req-variedad="{{ req }}">{{ nombre }}</option>
        {% endfor %}
      </select><br><br>

      <label for="variedad">Variedad:</label>
      <select name="variedad" id="variedad" disabled>
          <option value="">-- Seleccione una variedad --</option>
          {% for id, nombre in variedades %}
          <option value="{{ nombre }}">{{ nombre }}</option>
          {% endfor %}
      </select>
      <small>Se activará si el producto lo requiere.</small><br><br>

    </fieldset>

    <fieldset>
      <legend>Cálculo de Ingreso</legend>

      <label for="cantidad_procesada">Cantidad Recibida del Cliente:</label>
      <input type="number" step="0.01" name="cantidad_procesada" id="cantidad_procesada" required min="0.01"><br><br>

      <label for="unidad">Unidad de Medida:</label>
      <select name="unidad" id="unidad">
          <option value="quintal" selected>Quintales</option>
          <option value="fanega">Fanegas</option>
      </select><br><br>

      <label for="precio_fanega">Precio a Cobrar por Fanega:</label>
      <input type="number" step="0.01" name="precio_fanega" id="precio_fanega" required min="0"><br><br>

      <label for="total_ingreso">Ingreso Total Estimado:</label>
      <input type="text" id="total_ingreso" readonly style="font-weight: bold; border: none;"><br><br>

    </fieldset>

    <fieldset>
        <legend>Información Adicional</legend>
        <label for="observaciones">Observaciones:</label><br>
        <textarea name="observaciones" id="observaciones" rows="3" style="width: 100%;"></textarea>
    </fieldset>

    <br>
    <button type="submit">Registrar Servicio</button>
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Habilitar/deshabilitar variedad según el producto
        const productoSelect = document.getElementById('producto_id');
        const variedadSelect = document.getElementById('variedad');
        productoSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const requiereVariedad = selectedOption.getAttribute('data-req-variedad') === '1';
            variedadSelect.disabled = !requiereVariedad;
            if (!requiereVariedad) variedadSelect.value = '';
        });

        // Calcular ingreso total
        const cantidadInput = document.getElementById('cantidad_procesada');
        const unidadSelect = document.getElementById('unidad');
        const precioInput = document.getElementById('precio_fanega');
        const totalInput = document.getElementById('total_ingreso');

        function calcularIngreso() {
            const cantidad = parseFloat(cantidadInput.value.replace(',', '.')) || 0;
            const precio = parseFloat(precioInput.value.replace(',', '.')) || 0;
            const esQuintal = unidadSelect.value === 'quintal';
            const factorConversion = 46 / 200; // quintales a fanegas
            const cantidadEnFanegas = esQuintal ? cantidad * factorConversion : cantidad;
            totalInput.value = '$' + (cantidadEnFanegas * precio).toFixed(2);
        }
        cantidadInput.addEventListener('input', calcularIngreso);
        unidadSelect.addEventListener('input', calcularIngreso);
        precioInput.addEventListener('input', calcularIngreso);
    });
  </script>
{% endblock %}
