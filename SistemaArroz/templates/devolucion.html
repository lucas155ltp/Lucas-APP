{% extends "layout.html" %}

{% block title %}Registrar Devolución{% endblock %}

{% block content %}
  <h1>Registrar Devolución</h1>
  <p>Estás a punto de registrar una devolución para la siguiente venta. El inventario se ajustará automáticamente.</p>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% if transaccion %}
  <form method="post">
    <fieldset>
      <legend>Detalles de la Venta Original (ID: {{ transaccion.id }})</legend>
      <p><strong>Cliente:</strong> {{ transaccion.nombre }}</p>
      <p><strong>Fecha de Venta:</strong> {{ transaccion.fecha }}</p>
      <p><strong>Producto:</strong> {{ transaccion.producto_nombre }}</p>
      <p><strong>Lote:</strong> {{ transaccion.lote }}</p>
      <p><strong>Cantidad Vendida:</strong> {{ "%.2f"|format(transaccion.cantidad) }} {{ transaccion.unidad }}</p>
      <p><strong>Precio de Venta Unitario:</strong> ${{ "%.2f"|format(transaccion.precio_unitario) }}</p>
    </fieldset>
    
    <br>
    <fieldset>
        <legend>Datos de la Devolución</legend>
        <div class="form-group">
          <label for="cantidad_devuelta">Unidades a Devolver:</label>
          <input type="number" step="0.01" name="cantidad_devuelta" id="cantidad_devuelta" required min="0.01" max="{{ transaccion.cantidad }}" value="{{ transaccion.cantidad }}">
          <small>No puede ser mayor a la cantidad vendida originalmente.</small>
        </div>
    </fieldset>
    <br>
    <button type="submit">Confirmar Devolución</button>
    <a href="{{ url_for('historial') }}" class="button-secondary">Cancelar</a>
  </form>
  {% else %}
    <p>No se encontró la transacción de venta original.</p>
  {% endif %}
{% endblock %}
