{% extends "layout.html" %}

{% block title %}Carrito de Venta{% endblock %}

{% block content %}
  <h1>Carrito de Venta</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% if not carrito or carrito|length == 0 %}
    <p>El carrito de venta está vacío.</p>
    <a href="{{ url_for('main.inventario') }}" class="button-secondary">Volver al Inventario</a>
  {% else %}
    <form method="post" action="{{ url_for('transactions.finalizar_venta') }}">
      <table class="responsive-table">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Lote</th>
            <th>Cantidad</th>
            <th>Precio Unit.</th>
            <th>Subtotal</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for item_id, item in carrito.items() %}
          <tr>
            <td data-label="Producto">{{ item.nombre_producto }} ({{ item.variedad or 'N/A' }})</td>
            <td data-label="Lote">{{ item.lote }}</td>
            <td data-label="Cantidad">
              <input type="number" name="cantidad_{{ item_id }}" value="{{ item.cantidad }}" min="0.01" max="{{ item.stock_disponible }}" step="0.01" style="width: 80px;">
              {{ item.unidad }}
            </td>
            <td data-label="Precio Unit.">${{ "%.2f"|format(item.precio) }}</td>
            <td data-label="Subtotal">${{ "%.2f"|format(item.cantidad * item.precio) }}</td>
            <td data-label="Acciones">
              <a href="{{ url_for('transactions.eliminar_del_carrito', item_id=item_id) }}" class="action-button" style="background-color: #dc3545;">Eliminar</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <td colspan="4" style="text-align: right; font-weight: bold;">Total de la Venta:</td>
            <td data-label="Total" style="font-weight: bold;">${{ "%.2f"|format(total) }}</td>
            <td></td>
          </tr>
        </tfoot>
      </table>

      <div style="margin-top: 2em;">
        <fieldset>
          <legend>Finalizar Venta</legend>
          <div class="form-group">
            <label for="comprador">Nombre del Comprador:</label>
            <input type="text" name="comprador" id="comprador" required>
          </div>
          <div class="form-group">
            <label for="observaciones">Observaciones (Opcional):</label>
            <textarea name="observaciones" id="observaciones" rows="2" style="width: 100%;"></textarea>
          </div>
        </fieldset>
      </div>

      <div style="margin-top: 1em; display: flex; gap: 1em;">
        <button type="submit" name="action" value="update">Actualizar Cantidades</button>
        <button type="submit" name="action" value="finalize" style="background-color: #28a745;">Finalizar Venta</button>
        <a href="{{ url_for('main.inventario') }}" class="button-secondary">Seguir Añadiendo</a>
      </div>
    </form>
  {% endif %}

  <script>
    // Pequeño script para confirmar la finalización de la venta
    document.querySelector('form').addEventListener('submit', function(e) {
      const action = e.submitter.value;
      if (action === 'finalize') {
        if (!confirm('¿Estás seguro de que quieres finalizar esta venta? Esta acción descontará el stock del inventario.')) {
          e.preventDefault();
        }
      }
    });
  </script>
{% endblock %}
