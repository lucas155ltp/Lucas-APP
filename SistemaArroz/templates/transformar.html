{% extends "layout.html" %}

{% block title %}Transformar Lote{% endblock %}

{% block content %}
  <h1>Transformar Lote (Pelado)</h1>
  <p>Este proceso convierte la materia prima en productos derivados. Solo se muestran los lotes con estado 'Seco'.</p>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="post" id="transform-form">
    <fieldset>
       <legend>Lote de Origen (Arroz Semilla)</legend>
      
      <label for="item_origen_id">Seleccionar Lote:</label>
      <select name="item_origen_id" id="item_origen_id" required>
        <option value="" disabled selected>-- Elija un lote --</option>
        {% for id, lote, cantidad, unidad, nombre, variedad, almacen_id in lotes %}
          <option value="{{ id }}" data-cantidad-max="{{ cantidad }}" data-almacen-id="{{ almacen_id or '' }}" data-lote="{{ lote }}">
            ID: {{ id }} | Lote: {{ lote }} | Variedad: {{ variedad or 'N/A' }} | Disp: {{ "%.2f"|format(cantidad) }} {{ unidad }}
          </option>
        {% endfor %}
      </select>
      <br><br>

      <label for="lote_manual_input">O ingrese el Número de Lote:</label>
      <input type="text" id="lote_manual_input" placeholder="Escriba el lote y presione Enter o tabule">
      <small id="lote-manual-info" style="color: red;"></small>
      <br><br>

      <label for="cantidad_usada">Cantidad a Usar:</label>
      <input type="number" step="0.01" name="cantidad_usada" id="cantidad_usada" required>
      <small id="cantidad-disponible-info"></small>
      <br><br>
    </fieldset>

    <fieldset>
      <legend>Productos Resultantes (en quintales)</legend>
      {% for p_id, p_nombre, p_req_variedad in productos_derivados %}
        <label for="cantidad_producto_{{ p_id }}">{{ p_nombre }}:</label>
        <input type="number" step="0.01" name="cantidad_producto_{{ p_id }}" id="cantidad_producto_{{ p_id }}" value="0.0">
        <br><br>
      {% endfor %}

      <label for="destino_almacen_id"><strong>Almacén de Destino:</strong></label>
      <select name="destino_almacen_id" id="destino_almacen_id" required>
        <option value="" disabled selected>-- Elija un almacén --</option>
        {% for id, nombre in almacenes %}
          <option value="{{ id }}">{{ nombre }}</option>
        {% endfor %}
      </select>
    </fieldset>

    <fieldset>
        <legend>Información Adicional</legend>
        <label for="observaciones">Observaciones:</label><br>
        <textarea name="observaciones" id="observaciones" rows="3" style="width: 100%;"></textarea>
    </fieldset>

    <br>
    <button type="submit">Confirmar Transformación</button>
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const loteSelect = document.getElementById('item_origen_id');
        const cantidadInput = document.getElementById('cantidad_usada');
        const cantidadInfo = document.getElementById('cantidad-disponible-info');
        const destinoAlmacenSelect = document.getElementById('destino_almacen_id');
        const loteManualInput = document.getElementById('lote_manual_input');
        const loteManualInfo = document.getElementById('lote-manual-info');

        loteSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const cantidadMax = selectedOption.getAttribute('data-cantidad-max');
            const almacenId = selectedOption.getAttribute('data-almacen-id');

             if (cantidadMax) {
                cantidadInput.max = cantidadMax;
                cantidadInput.placeholder = `Máx: ${parseFloat(cantidadMax).toFixed(2)}`;
                cantidadInfo.textContent = `(Disponible: ${parseFloat(cantidadMax).toFixed(2)})`;
            } else {
                cantidadInput.max = null;
                cantidadInput.placeholder = '';
                cantidadInfo.textContent = '';
            }
 
            // Pre-seleccionar el almacén de destino
            if (almacenId) {
                destinoAlmacenSelect.value = almacenId;
            } else {
                destinoAlmacenSelect.value = "";
            }

            // Actualizar el campo de texto manual
            if (selectedOption && selectedOption.value) {
                loteManualInput.value = selectedOption.dataset.lote || '';
                loteManualInfo.textContent = '';
            } else {
                loteManualInput.value = '';
            }
        });

        loteManualInput.addEventListener('change', function() {
            const loteBuscado = this.value.trim().toUpperCase(); // Normalizar a mayúsculas
            loteManualInfo.textContent = '';
            if (!loteBuscado) return;

            let found = false;
            for (const option of loteSelect.options) {
                if (option.dataset.lote && option.dataset.lote.toUpperCase() === loteBuscado) {
                    loteSelect.value = option.value;
                    loteSelect.dispatchEvent(new Event('change')); // Disparar evento para actualizar todo
                    found = true;
                    break;
                }
            }

            if (!found) {
                loteManualInfo.textContent = 'Lote no encontrado o no disponible.';
                loteSelect.value = ""; // Resetear dropdown
                loteSelect.dispatchEvent(new Event('change'));
            }
        });

        cantidadInput.addEventListener('input', function() {
            const max = parseFloat(this.max);
            const val = parseFloat(this.value);
            if (max && val > max) {
                this.value = max.toFixed(2);
            } else if (val < 0) {
                this.value = '0.0';
            }
        });
    });
  </script>

{% endblock %}