{% extends "layout.html" %}

{% block title %}Registrar Compra{% endblock %}

{% block content %}
  <h1>Registrar Compra</h1>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}
  <form method="post" id="compra-form">
    <div class="form-group">
      <label for="proveedor">Proveedor:</label>
      <input type="text" name="proveedor" id="proveedor" required>
    </div>
    <div class="form-group">
      <label for="producto_id">Producto:</label>
      <select name="producto_id" id="producto_id" required>
        <option value="" disabled selected>Seleccione un producto</option>
        {% for id, nombre, req in productos %}
          <option value="{{ id }}" data-req-variedad="{{ req }}">{{ nombre }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-group">
      <label for="variedad">Variedad:</label>
      <select name="variedad" id="variedad" disabled>
          <option value="">-- Seleccione una variedad --</option>
          {% for id, nombre in variedades %}
          <option value="{{ nombre }}">{{ nombre }}</option>
          {% endfor %}
      </select>
      <small>Se activará si el producto lo requiere.</small>
    </div>
    <div class="form-group">
      <label for="almacen_id">Almacén de Destino:</label>
      <select name="almacen_id" id="almacen_id" required>
        <option value="" disabled selected>Seleccione un almacén</option>
        {% for id, nombre in almacenes %}
          <option value="{{ id }}">{{ nombre }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-group">
      <label for="unidades">Unidades:</label>
      <input type="number" step="0.01" name="unidades" id="unidades" required>
    </div>
    <div class="form-group">
      <label for="tipo_unidad">Tipo de Unidad:</label>
      <select name="tipo_unidad" id="tipo_unidad">
          <option value="quintal">Quintales</option>
          <option value="fanega">Fanegas</option>
      </select>
    </div>
    <div class="form-group">
      <label for="estado">Estado Inicial del Lote:</label>
      <select name="estado" id="estado">
          <option value="mojado" selected>Mojado</option>
          <option value="seco">Seco</option>
      </select>
    </div>
    <div class="form-group">
      <label for="precio">Precio por Unidad:</label>
      <input type="number" step="0.01" name="precio" id="precio" required>
    </div>
    <div class="form-group">
      <label for="total">Total:</label>
      <input type="text" id="total" readonly style="font-weight: bold; border: none;">
    </div>
    <div class="form-group">
      <label for="lote">Número de Lote:</label>
      <div style="display: flex; gap: 10px; align-items: center;">
        <input type="text" name="lote" id="lote" required style="flex-grow: 1;">
        <button type="button" id="generar-lote-btn" title="Generar un número de lote único">Generar</button>
      </div>
    </div>
    <button type="submit">Registrar Compra</button>
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const productoSelect = document.getElementById('producto_id');
        const variedadInput = document.getElementById('variedad');
        const cantidadInput = document.getElementById('unidades');
        const precioInput = document.getElementById('precio');
        const totalInput = document.getElementById('total');
        const loteInput = document.getElementById('lote');
        const generarLoteBtn = document.getElementById('generar-lote-btn');

        if (generarLoteBtn) {
            generarLoteBtn.addEventListener('click', function() {
                this.disabled = true;
                this.textContent = '...';

                fetch("{{ url_for('reports.generar_lote') }}")
                    .then(response => {
                        // Si la respuesta no es OK, procesamos el error
                        if (!response.ok) {
                            // Si es un error de autenticación, recargamos la página para ir al login
                            if (response.status === 401) {
                                window.location.reload();
                            }
                            // Para otros errores, intentamos leer el JSON de error del backend
                            return response.json().then(err => Promise.reject(err));
                        }
                        return response.json(); // Si todo está bien, procesamos el JSON
                    })
                    .then(data => {
                        if (data.lote) {
                            loteInput.value = data.lote;
                        } else {
                            alert('No se pudo generar el número de lote: ' + (data.error || 'Error desconocido.'));
                        }
                    })
                    .catch(error => {
                        // 'error' ahora puede ser un objeto JSON del backend o un error de red
                        console.error('Error al generar lote:', error.error || error);
                        if (error.error) {
                            alert('No se pudo generar el lote: ' + error.error);
                        } else {
                            alert('Ocurrió un error de red al generar el lote. Por favor, inténtelo de nuevo.');
                        }
                    })
                    .finally(() => {
                        this.disabled = false;
                        this.textContent = 'Generar';
                    });
            });
        }

        productoSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const requiereVariedad = selectedOption.getAttribute('data-req-variedad') === '1';
            variedadInput.disabled = !requiereVariedad;
            variedadInput.required = requiereVariedad;
            if (!requiereVariedad) variedadInput.value = '';
        });

        function calcularTotal() {
            const cantidad = parseFloat(cantidadInput.value) || 0;
            const precio = parseFloat(precioInput.value) || 0;
            totalInput.value = (cantidad * precio).toFixed(2);
        }

        cantidadInput.addEventListener('input', calcularTotal);
        precioInput.addEventListener('input', calcularTotal);

        // Prevenir doble submit del formulario de compra
        const compraForm = document.getElementById('compra-form');
        if (compraForm) {
            compraForm.addEventListener('submit', function() {
                const submitButton = compraForm.querySelector('button[type="submit"]');
                if (submitButton) submitButton.disabled = true;
            });
        }
    });
  </script>
{% endblock %}