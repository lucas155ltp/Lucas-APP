{% extends "layout.html" %}

{% block title %}Historial{% endblock %}

{% block content %}
  <h1>Historial</h1>

  <form method="get" action="{{ url_for('main.historial') }}" class="filter-form" id="historial-filter-form">
    <div class="filter-group">
      <label for="periodo_tipo">Filtrar por Fecha:</label>
      <select name="periodo_tipo" id="periodo_tipo">
        <option value="todos" {% if not filtros_activos.get('periodo_tipo') or filtros_activos.get('periodo_tipo') == 'todos' %}selected{% endif %}>Todo el tiempo</option>
        <option value="rango" {% if filtros_activos.get('periodo_tipo') == 'rango' %}selected{% endif %}>Rango de Fechas</option>
        <option value="mensual" {% if filtros_activos.get('periodo_tipo') == 'mensual' %}selected{% endif %}>Mensual</option>
        <option value="temporada" {% if filtros_activos.get('periodo_tipo') == 'temporada' %}selected{% endif %}>Por Temporada</option>
      </select>
    </div>

    <div class="filter-group" id="filtro-rango" style="display:none;">
      <label for="fecha_inicio">Desde:</label>
      <input type="date" name="fecha_inicio" id="fecha_inicio" value="{{ filtros_activos.get('fecha_inicio', '') }}">
      <label for="fecha_fin">Hasta:</label>
      <input type="date" name="fecha_fin" id="fecha_fin" value="{{ filtros_activos.get('fecha_fin', '') }}">
    </div>

    <div class="filter-group" id="filtro-mensual" style="display:none;">
      <label for="mes">Mes:</label>
      <select name="mes" id="mes">
        {% for mes_num, mes_nombre in meses %}
          <option value="{{ mes_num }}" {% if filtros_activos.get('mes')|int == mes_num %}selected{% endif %}>{{ mes_nombre }}</option>
        {% endfor %}
      </select>
      <label for="año_mensual">Año:</label>
      <select name="año" id="año_mensual">
        {% for año in años %}
          <option value="{{ año }}" {% if filtros_activos.get('año')|int == año %}selected{% endif %}>{{ año }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="filter-group" id="filtro-temporada" style="display:none;">
      <label for="temporada">Temporada:</label>
      <select name="temporada" id="temporada">
        <option value="zafra" {% if filtros_activos.get('temporada') == 'zafra' %}selected{% endif %}>Zafra (Feb-May)</option>
        <option value="descanso" {% if filtros_activos.get('temporada') == 'descanso' %}selected{% endif %}>Descanso (Jun-Ene)</option>
      </select>
      <label for="año_temporada">Año de Inicio:</label>
      <select name="año" id="año_temporada">
        {% for año in años %}
          <option value="{{ año }}" {% if filtros_activos.get('año')|int == año %}selected{% endif %}>{{ año }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="filter-group">
      <label for="tipo">Tipo Transacción:</label>
      <select name="tipo">
          <option value="">Todos</option>
          <option value="compra" {% if filtros_activos.get('tipo') == 'compra' %}selected{% endif %}>Compra</option>
          <option value="venta" {% if filtros_activos.get('tipo') == 'venta' %}selected{% endif %}>Venta</option>
          <option value="devolucion" {% if filtros_activos.get('tipo') == 'devolucion' %}selected{% endif %}>Devolución</option>
          <option value="transformacion" {% if filtros_activos.get('tipo') == 'transformacion' %}selected{% endif %}>Transformación</option>
          <option value="secado" {% if filtros_activos.get('tipo') == 'secado' %}selected{% endif %}>Secado</option>
          <option value="servicio_secado" {% if filtros_activos.get('tipo') == 'servicio_secado' %}selected{% endif %}>Servicio Secado (Cliente)</option>
          <option value="servicio_pelado" {% if filtros_activos.get('tipo') == 'servicio_pelado' %}selected{% endif %}>Servicio Pelado (Cliente)</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="producto_id">Producto:</label>
      <select name="producto_id">
          <option value="">Todos</option>
          {% for id, nombre, _ in productos %}
          <option value="{{ id }}" {% if filtros_activos.get('producto_id')|int == id %}selected{% endif %}>{{ nombre }}</option>
          {% endfor %}
      </select>
    </div>

    <div class="filter-group">
      <label for="nombre">Nombre/Detalle:</label>
      <input type="text" name="nombre" value="{{ filtros_activos.get('nombre', '') }}">
    </div>

    <div class="filter-group">
      <label for="lote">Lote:</label>
      <input type="text" name="lote" value="{{ filtros_activos.get('lote', '') }}">
    </div>

    <div class="filter-buttons">
      <button type="submit">Filtrar</button>
      {% if g.user.nivel_acceso != 'empleado' %}
        <a href="{{ url_for('reports.exportar', reporte_nombre='historial', **filtros_activos) }}" class="button-secondary">
          Exportar a Excel
        </a>
      {% endif %}
    </div>
  </form>

  <table class="responsive-table">
    <thead>
      <tr>
        <th>ID Trans.</th>
        <th>Tipo</th>
        <th>Nombre/Detalle</th>
        <th>Fecha</th>
        <th>Producto</th>
        <th>Código</th>
        <th>Variedad</th>
        <th>Unidades</th>
        <th>Tipo de Unidad</th>
        <th>Precio Unit.</th>
        <th>Subtotal</th>
        <th>Lote</th>
        <th>Observaciones</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for id, tipo, nombre, fecha, producto, codigo, variedad, cantidad, cantidad_kg, unidad, precio, subtotal, lote, observaciones in historial %}
      <tr>
        <td data-label="ID Trans.">{{ id }}</td>
        <td data-label="Tipo">{{ tipo }}</td>
        <td data-label="Nombre/Detalle">{{ nombre }}</td>
        <td data-label="Fecha">{{ fecha }}</td>
        <td data-label="Producto">{{ producto or 'N/A' }}</td>
        <td data-label="Código">{{ codigo or 'N/A' }}</td>
        <td data-label="Variedad">{{ variedad or 'N/A' }}</td>
        <td data-label="Unidades">{{ "%.2f"|format(cantidad) if cantidad is not none else '' }}</td>
        <td data-label="Tipo de Unidad">{{ unidad or 'N/A' }}</td>
        <td data-label="Precio Unit.">{{ "%.2f"|format(precio) if precio is not none else '' }}</td>
        <td data-label="Subtotal">{{ "%.2f"|format(subtotal) if subtotal is not none else '' }}</td>
        <td data-label="Lote">{{ lote or 'N/A' }}</td>
        <td data-label="Observaciones">{{ observaciones or 'N/A' }}</td>
        <td data-label="Acciones">
          {% if tipo == 'venta' %}
            <div class="actions-container">
              <button class="action-button qr-button" data-id="{{ id }}" style="background-color: #28a745;">Compartir (QR)</button>
              <a href="{{ url_for('reports.generar_factura', transaccion_id=id) }}" class="action-button" style="background-color: #007bff;">Factura (.docx)</a>
              <a href="{{ url_for('transactions.registrar_devolucion', transaccion_id=id) }}" class="action-button" style="background-color: #ffc107; color: black;">Devolución</a>
            </div>
          {% elif tipo in ['servicio_secado', 'servicio_pelado'] %}
            <div class="actions-container">
              <button class="action-button qr-button" data-id="{{ id }}" style="background-color: #28a745;">Compartir (QR)</button>
              <a href="{{ url_for('reports.generar_factura', transaccion_id=id) }}" class="action-button" style="background-color: #007bff;">Factura (.docx)</a>
            </div>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="15">No hay transacciones que coincidan con los filtros.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

<!-- Modal para el Código QR -->
<div id="qr-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close-button">&times;</span>
    <h2>Compartir Factura Digital</h2>
    <p>Escanea este código QR con un teléfono para ver la factura en línea.</p>
    <div id="qr-code-container">
      <!-- El código QR se cargará aquí -->
      <img id="qr-code-image" src="" alt="Código QR" style="width: 250px; height: 250px; margin: 0 auto; display: block;">
      <p id="qr-loading-text" style="text-align: center; display: none;">Generando QR...</p>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const periodoSelect = document.getElementById('periodo_tipo');
    const filtroRango = document.getElementById('filtro-rango');
    const filtroMensual = document.getElementById('filtro-mensual');
    const filtroTemporada = document.getElementById('filtro-temporada');
    const añoMensualSelect = document.getElementById('año_mensual');
    const añoTemporadaSelect = document.getElementById('año_temporada');

    function toggleFiltros() {
      const valor = periodoSelect.value;
      filtroRango.style.display = 'none';
      filtroMensual.style.display = 'none';
      filtroTemporada.style.display = 'none';
      añoMensualSelect.name = ''; // Desactivar el 'name' para que no se envíe
      añoTemporadaSelect.name = '';

      if (valor === 'rango') {
        filtroRango.style.display = 'flex';
      } else if (valor === 'mensual') {
        filtroMensual.style.display = 'flex';
        añoMensualSelect.name = 'año'; // Reactivar el 'name'
      } else if (valor === 'temporada') {
        filtroTemporada.style.display = 'flex';
        añoTemporadaSelect.name = 'año';
      }
    }

    periodoSelect.addEventListener('change', toggleFiltros);
    // Ejecutar al cargar la página para establecer el estado inicial correcto
    toggleFiltros();

    // --- Lógica para el Modal del Código QR ---
    const modal = document.getElementById('qr-modal');
    const closeButton = modal.querySelector('.close-button');
    const qrButtons = document.querySelectorAll('.qr-button');
    const qrImage = document.getElementById('qr-code-image');
    const qrLoadingText = document.getElementById('qr-loading-text');

    qrButtons.forEach(button => {
      button.addEventListener('click', function() {
        const transaccionId = this.getAttribute('data-id');
        
        // Mostrar texto de carga y ocultar imagen anterior
        qrImage.style.display = 'none';
        qrLoadingText.style.display = 'block';
        modal.style.display = 'flex';
        
        // Cuando la nueva imagen del QR se haya cargado completamente en el navegador...
        qrImage.onload = () => {
          // ...ocultar el texto de "cargando" y mostrar la imagen.
          qrLoadingText.style.display = 'none';
          qrImage.style.display = 'block';
        };
        // Si hay un error al cargar la imagen (ej. factura no encontrada)
        qrImage.onerror = () => {
          qrLoadingText.textContent = 'Error al generar el QR. Intente de nuevo.';
        };
        // Iniciar la carga de la nueva imagen. Esto debe ir al final.
        qrImage.src = `/api/qr_code/${transaccionId}`;
      });
    });

    closeButton.addEventListener('click', () => {
      modal.style.display = 'none';
      qrImage.src = ''; // Limpiar la imagen para la próxima vez
    });

    // --- Lógica para el Modal del Código QR (versión anterior para referencia) ---
    /*
    const modal = document.getElementById('qr-modal');
    const closeButton = modal.querySelector('.close-button');
    const qrButtons = document.querySelectorAll('.qr-button');
    const qrImage = document.getElementById('qr-code-image');
    const qrLoadingText = document.getElementById('qr-loading-text');

    qrButtons.forEach(button => {
      button.addEventListener('click', function() {
        const transaccionId = this.getAttribute('data-id');
        
        // Mostrar texto de carga y ocultar imagen anterior
        qrImage.style.display = 'none';
        qrLoadingText.style.display = 'block';
        modal.style.display = 'flex';

        // Establecer la fuente de la imagen para cargar el nuevo QR
        qrImage.src = `/api/qr_code/${transaccionId}`;
        
        // Cuando la imagen se cargue, ocultar el texto de carga
        qrImage.onload = () => {
          qrLoadingText.style.display = 'none';
          qrImage.style.display = 'block';
        };
      });
    });

    closeButton.addEventListener('click', () => {
      modal.style.display = 'none';
      qrImage.src = ''; // Limpiar la imagen para la próxima vez
    });
    */
  });
</script>
{% endblock %}